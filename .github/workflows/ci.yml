name: CI

on:
  push:
    branches: [main, octave-build]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Fast path for docs-only changes
  check-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.filter.outputs.docs_only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        id: filter
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            FILES=$(git diff --name-only HEAD^ HEAD || echo "")
          fi

          # If no files changed (initial commit), run full tests
          if [ -z "$FILES" ]; then
            echo "docs_only=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if all changes are docs-only
          DOCS_ONLY=true
          while IFS= read -r file; do
            # Runtime code that must trigger tests:
            # - src/ directory (including src/octave_mcp/schemas/builtin/*.oct.md)
            # - tests/ directory
            # - pyproject.toml, setup.py, requirements.txt
            # - .github/workflows/
            if [[ "$file" =~ ^src/ ]] || \
               [[ "$file" =~ ^tests/ ]] || \
               [[ "$file" =~ ^(pyproject\.toml|setup\.py|requirements.*\.txt)$ ]] || \
               [[ "$file" =~ ^\.github/workflows/ ]]; then
              DOCS_ONLY=false
              break
            fi

            # Documentation-only paths (safe to skip tests):
            # - specs/ directory (.oct.md specifications)
            # - docs/ directory
            # - Root-level markdown files (README.md, CHANGELOG.md, etc.)
            # - LICENSE files
            # - Markdown linter configs
            if [[ "$file" =~ ^specs/ ]] || \
               [[ "$file" =~ ^docs/ ]] || \
               [[ "$file" =~ ^\w+\.(md|txt)$ ]] || \
               [[ "$file" =~ ^LICENSE ]] || \
               [[ "$file" =~ ^\.markdownlint ]]; then
              continue
            fi

            # Any other file triggers full tests
            DOCS_ONLY=false
            break
          done <<< "$FILES"

          echo "docs_only=$DOCS_ONLY" >> $GITHUB_OUTPUT
          echo "Documentation-only changes: $DOCS_ONLY"

  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    needs: check-changes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation files exist
        run: |
          test -f README.md
          test -f docs/usage.md
          test -f docs/api.md
          test -f docs/mcp-configuration.md

      - name: Check Markdown formatting
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: |
            README.md
            docs/**/*.md
        continue-on-error: true

  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.docs_only != 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ruff linting
        run: |
          ruff check src tests

      - name: Run black format check
        run: |
          black --check src tests

      - name: Run mypy type checking
        run: |
          mypy src

      - name: Run pytest with coverage
        run: |
          pytest --cov=octave_mcp --cov-report=xml --cov-report=term-missing --cov-fail-under=85

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.12'
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # Removed - integration tests now run from wheel in integration-from-wheel job

  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    needs: [check-changes, test]
    if: needs.check-changes.outputs.docs_only != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run property tests with increased iterations
        run: |
          pytest tests/properties/ -v --hypothesis-profile=ci --no-cov

  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    needs: [check-changes, test]
    if: needs.check-changes.outputs.docs_only != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build

      - name: Check package
        run: |
          twine check dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  artifact-validate:
    name: Validate Distribution Artifact
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Install wheel in clean environment
        run: |
          TEMP_DIR="$(mktemp -d)"
          cd "$TEMP_DIR"
          python -m pip install "$GITHUB_WORKSPACE"/dist/*.whl
          python -c "import octave_mcp; print(f'IMPORTED_FROM::{octave_mcp.__file__}')"

      - name: Assert no test files in installed package
        run: |
          TEMP_DIR="$(mktemp -d)"
          cd "$TEMP_DIR"
          python -m pip install "$GITHUB_WORKSPACE"/dist/*.whl
          python - <<'PY'
          import pathlib
          import octave_mcp
          pkg = pathlib.Path(octave_mcp.__file__).resolve().parent
          test_files = list(pkg.rglob("test_*.py"))
          assert not test_files, f"test_files_found_in_wheel::{test_files}"
          PY

      - name: Assert no tests/ paths in wheel
        run: |
          unzip -l dist/*.whl | grep -E "tests/" && echo "ERROR::tests_paths_found_in_wheel" && exit 1 || echo "OK::no_tests_paths_in_wheel"

      - name: Verify package data included
        run: |
          TEMP_DIR="$(mktemp -d)"
          cd "$TEMP_DIR"
          python -m pip install "$GITHUB_WORKSPACE"/dist/*.whl
          python - <<'PY'
          import pathlib
          import octave_mcp
          pkg = pathlib.Path(octave_mcp.__file__).resolve().parent
          schema_file = pkg / "schemas" / "builtin" / "meta.oct.md"
          assert schema_file.exists(), f"schema_file_missing::{schema_file}"
          print(f"OK::schema_file_present::{schema_file}")
          PY

  integration-from-wheel:
    name: Integration Tests (from wheel)
    runs-on: ubuntu-latest
    needs: [artifact-validate]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Install wheel with test dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python -m pip install pytest pytest-asyncio

      - name: Test CLI commands
        run: |
          # Create test document
          cat > test.oct.md <<EOF
          META:
            TYPE::"TEST_DOCUMENT"
            VERSION::"1.0"

          TEST:
            ID::"TEST-001"
            STATUS::"active"
          EOF

          # Test ingest
          octave ingest test.oct.md

          # Test validate
          octave validate test.oct.md

          # Test eject
          octave eject test.oct.md --mode canonical

      - name: Test MCP server startup
        run: |
          # Test server can start and respond to initialization
          timeout 5s octave-mcp-server || true
          # Exit code 124 means timeout (server started but didn't exit)
          # This is expected for a server that waits for input

  final-gate:
    name: Final Gate
    runs-on: ubuntu-latest
    if: always()
    needs: [check-changes, docs, test, property-tests, build, artifact-validate, integration-from-wheel]

    steps:
      - name: Determine required checks
        id: required
        run: |
          DOCS_ONLY="${{ needs.check-changes.outputs.docs_only }}"

          echo "docs_only=$DOCS_ONLY"
          echo "docs_result=${{ needs.docs.result }}"
          echo "test_result=${{ needs.test.result }}"
          echo "property_tests_result=${{ needs.property-tests.result }}"
          echo "build_result=${{ needs.build.result }}"
          echo "artifact_validate_result=${{ needs.artifact-validate.result }}"
          echo "integration_from_wheel_result=${{ needs.integration-from-wheel.result }}"

      - name: Validate results
        run: |
          DOCS_ONLY="${{ needs.check-changes.outputs.docs_only }}"

          # Docs must always pass
          if [ "${{ needs.docs.result }}" != "success" ]; then
            echo "ERROR::required_job_failed::docs::${{ needs.docs.result }}"
            exit 1
          fi

          # For docs-only changes, skip code validation
          if [ "$DOCS_ONLY" == "true" ]; then
            echo "OK::docs_only_change::skipping_code_validation"
            exit 0
          fi

          # For code changes, all jobs must pass
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "ERROR::required_job_failed::test::${{ needs.test.result }}"
            exit 1
          fi

          if [ "${{ needs.property-tests.result }}" != "success" ]; then
            echo "ERROR::required_job_failed::property-tests::${{ needs.property-tests.result }}"
            exit 1
          fi

          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "ERROR::required_job_failed::build::${{ needs.build.result }}"
            exit 1
          fi

          if [ "${{ needs.artifact-validate.result }}" != "success" ]; then
            echo "ERROR::required_job_failed::artifact-validate::${{ needs.artifact-validate.result }}"
            exit 1
          fi

          if [ "${{ needs.integration-from-wheel.result }}" != "success" ]; then
            echo "ERROR::required_job_failed::integration-from-wheel::${{ needs.integration-from-wheel.result }}"
            exit 1
          fi

          echo "OK::final_gate_passed"
